<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🏸 Inter-Hostel Badminton Fixtures (Live)</title>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #f4f7fb;
    color: #222;
    margin: 20px;
  }
  h2 { text-align: center; }
  .match {
    background: white;
    border-radius: 10px;
    padding: 12px;
    margin: 10px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .match span {
    float: right;
    font-weight: bold;
    color: green;
  }
  textarea { width: 100%; min-height: 120px; border-radius: 6px; padding: 8px; }
  input, select, button {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin: 4px;
  }
  button {
    cursor: pointer;
    background-color: #007bff;
    color: white;
    border: none;
  }
  button:hover {
    background-color: #0056b3;
  }
  #adminBox {
    background: #e9f1ff;
    padding: 12px;
    border-radius: 8px;
    margin-top: 10px;
  }
</style>
</head>

<body>
<h2>🏸 Inter-Hostel Badminton Fixtures (Live)</h2>

<div id="bracket">Loading fixtures…</div>

<hr>
<div id="adminLogin">
  <input id="pw" type="password" placeholder="Admin password">
  <button onclick="login()">Login</button>
</div>

<div id="adminBox" style="display:none">
  <h3>Admin Panel</h3>
  <textarea id="teams" placeholder="Enter team names (one per line)"></textarea><br>
  <label>Start Time: <input id="startTime" type="time"></label>
  <label>Court Count: <input id="courtCount" type="number" value="2" min="1"></label>
  <br>
  <button onclick="generate()">Generate Fixtures</button>
</div>

<script type="module">
/* ---------- Firebase Setup ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ---------- Your Firebase Config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAYEBi37iNUdsTzoAmuh47phNJkjD0245w",
  authDomain: "badminton-fixtures-5610f.firebaseapp.com",
  projectId: "badminton-fixtures-5610f",
  storageBucket: "badminton-fixtures-5610f.firebasestorage.app",
  messagingSenderId: "296007773773",
  appId: "1:296007773773:web:f59d1804da15464f587604",
  measurementId: "G-7T6Q002VRS"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ---------- Page Elements ---------- */
const bracketEl = document.getElementById("bracket");
const teamsEl   = document.getElementById("teams");
const pwEl      = document.getElementById("pw");
const adminBox  = document.getElementById("adminBox");
const startTimeEl = document.getElementById("startTime");
const courtCountEl = document.getElementById("courtCount");

let admin=false;
const docRef = doc(db,"fixtures","main");

/* ---------- Live Listener ---------- */
onSnapshot(docRef,(snap)=>{
  if(!snap.exists()){ 
    bracketEl.innerHTML="<p>No fixture yet</p>"; 
    return; 
  }
  renderBracket(snap.data());
});

/* ---------- Generate Fixtures ---------- */
async function generate(){
  if(!admin) return alert("Admin only");
  
  const lines = teamsEl.value.trim().split("\n").filter(x=>x);
  if(lines.length<2) return alert("Need 2 or more teams");

  const startTime = startTimeEl.value || "09:00";
  const courtCount = parseInt(courtCountEl.value) || 1;

  const matches=[];
  let currentTime = new Date(`2025-01-01T${startTime}:00`);
  let court=1;

  for(let i=0;i<lines.length;i+=2){
    const teamA=lines[i];
    const teamB=lines[i+1]||"BYE";
    const timeStr = currentTime.toTimeString().slice(0,5);

    matches.push({
      a:teamA,
      b:teamB,
      time:timeStr,
      court:court,
      winner:null
    });

    court++;
    if(court>courtCount){
      court=1;
      currentTime.setMinutes(currentTime.getMinutes()+30); // next round after 30 mins
    }
  }

  await setDoc(docRef,{teams:lines,matches});
  alert("Fixtures generated successfully!");
}

/* ---------- Set Winner ---------- */
async function setWinner(idx){
  if(!admin) return alert("Admin only");
  const snap=await getDoc(docRef);
  const data=snap.data();
  const m=data.matches[idx];
  const w=prompt(`Enter winner:\nA: ${m.a}\nB: ${m.b}`);
  if(!w) return;
  const winner = (w.toUpperCase()==='A')?m.a:(w.toUpperCase()==='B')?m.b:null;
  if(!winner) return alert("Invalid choice");
  data.matches[idx].winner=winner;
  await setDoc(docRef,data);
}

/* ---------- Render Fixtures ---------- */
function renderBracket(data){
  bracketEl.innerHTML="";
  data.matches.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="match";
    div.innerHTML=`
      <strong>${m.a}</strong> vs <strong>${m.b}</strong><br>
      🕓 ${m.time} | 🏟️ Court ${m.court}
      <span>${m.winner? '🏆 '+m.winner : ''}</span>
    `;
    if(admin){
      div.onclick=()=>setWinner(i);
    }
    bracketEl.appendChild(div);
  });
}

/* ---------- Admin Login ---------- */
window.login=()=>{
  const pass=pwEl.value.trim();
  if(pass==="admin123"){
    admin=true;
    adminBox.style.display='block';
    alert("Admin logged in!");
  } else {
    alert("Wrong password!");
  }
};

window.generate=generate;
</script>
</body>
</html>
